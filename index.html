<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan BPR (Excel Generator)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        
        .paper-preview {
            background: white;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
            border-top: 5px solid #107c41;
        }

        /* Preview Table Style (Hanya untuk preview di web) */
        table.preview-grid { width: 100%; border-collapse: collapse; font-size: 10pt; font-family: 'Calibri', sans-serif; }
        table.preview-grid th { background: #107c41; color: white; border: 1px solid white; text-align: center; padding: 5px; }
        table.preview-grid td { border: 1px solid #ccc; padding: 4px; white-space: nowrap; }
        .num { text-align: right; font-family: 'Consolas', monospace; }
        .text-neg { color: red; }
        .cat-row { background: #107c41; color: white; font-weight: bold; }
        .total-row { background: #eee; font-weight: bold; border-top: 2px solid black; }

        /* Modal */
        .modal-header { background: #107c41; color: white; }
        .file-box { border: 2px dashed #107c41; background: #f0fff4; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold text-success"><i class="bi bi-file-earmark-excel-fill"></i> Generator Laporan BPR (Format Excel)</h4>
        
        <div class="d-flex gap-2">
            <button class="btn btn-primary fw-bold" onclick="openModal()">
                <i class="bi bi-cloud-plus-fill"></i> INPUT DATA
            </button>
            <button class="btn btn-success fw-bold" onclick="exportToExcel()">
                <i class="bi bi-download"></i> DOWNLOAD EXCEL
            </button>
            <button class="btn btn-outline-secondary" onclick="resetAll()">Reset</button>
        </div>
    </div>

    <div class="paper-preview">
        <h5 class="text-center mb-3 fw-bold text-uppercase" style="color:#107c41;">Preview Data</h5>
        <table class="preview-grid">
            <thead>
                <tr>
                    <th rowspan="2">PERIODE</th>
                    <th rowspan="2">SANDI</th>
                    <th rowspan="2">ANGGOTA</th>
                    <th rowspan="2">PROVINSI</th>
                    <th rowspan="2">DATI II</th>
                    <th rowspan="2">MODAL DISETOR</th>
                    <th rowspan="2">TOTAL ASET</th>
                    <th rowspan="2">KYD</th>
                    <th rowspan="2">DPK</th>
                    <th rowspan="2">L/R TAHUN BERJALAN</th>
                    <th colspan="7">RASIO KEUANGAN (%)</th>
                </tr>
                <tr>
                    <th>KPMM</th><th>NPL</th><th>ROA</th><th>BOPO</th><th>NIM</th><th>LDR</th><th>CR</th>
                </tr>
            </thead>
            <tbody id="previewBody">
                <tr><td colspan="17" class="text-center text-muted p-4">Belum ada data. Silakan klik INPUT DATA.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="inputModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Input & Scraping Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scrapForm">
                    <div class="mb-3">
                        <label class="fw-bold text-success">Judul Kategori (Header Hijau)</label>
                        <input type="text" class="form-control fw-bold" id="kategori" placeholder="Contoh: BPR Sebelum Penggabungan (2023)">
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="fw-bold">Nama BPR</label><input type="text" class="form-control" id="namaBPR" required></div>
                        <div class="col-md-3"><label class="fw-bold">Periode</label><input type="text" class="form-control" id="periode" value="Desember"></div>
                        <div class="col-md-3"><label class="fw-bold">Sandi</label><input type="text" class="form-control" id="sandi"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><label class="fw-bold">Provinsi</label><input type="text" class="form-control" id="prov"></div>
                        <div class="col-md-6"><label class="fw-bold">Kota/Kab</label><input type="text" class="form-control" id="kota"></div>
                    </div>

                    <div class="file-box">
                        <label class="fw-bold">1. File Posisi Keuangan (Neraca)</label>
                        <input type="file" class="form-control" id="fileNeraca" accept=".xlsx,.xls,.csv">
                    </div>
                    <div class="file-box">
                        <label class="fw-bold">2. File Kualitas Aset (Rasio)</label>
                        <input type="file" class="form-control" id="fileKualitas" accept=".xlsx,.xls,.csv">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-success fw-bold" onclick="processData()">PROSES DATA</button>
            </div>
        </div>
    </div>
</div>

<script>
    let db = {};
    let lastBPRName = "Laporan_BPR";
    let modalInstance;

    document.addEventListener('DOMContentLoaded', () => {
        modalInstance = new bootstrap.Modal(document.getElementById('inputModal'));
    });

    function openModal() {
        document.getElementById('fileNeraca').value = "";
        document.getElementById('fileKualitas').value = "";
        modalInstance.show();
    }

    function resetAll() {
        if(confirm("Hapus semua data?")) {
            db = {};
            lastBPRName = "Laporan_BPR";
            renderPreview();
        }
    }

    // --- 1. PROSES SCRAPING (LOGIKANYA MASIH SAMA PERSIS) ---
    async function processData() {
        const kat = document.getElementById('kategori').value.trim();
        const nama = document.getElementById('namaBPR').value;
        const per = document.getElementById('periode').value;
        const sandi = document.getElementById('sandi').value;
        const prov = document.getElementById('prov').value;
        const kota = document.getElementById('kota').value;
        const fNeraca = document.getElementById('fileNeraca').files[0];
        const fKualitas = document.getElementById('fileKualitas').files[0];

        if (!kat || !nama || !fNeraca || !fKualitas) {
            alert("Mohon lengkapi semua data!"); return;
        }

        lastBPRName = nama; // Simpan nama buat file output

        try {
            const [dataNeraca, dataKualitas] = await Promise.all([readSheetJS(fNeraca), readSheetJS(fKualitas)]);

            // --- KOORDINAT SCRAPING ---
            const aset = getVal(dataNeraca, 40, 'F');
            const modal = findVal(dataNeraca, ['MODAL DISETOR'], 6);
            const kyd = getVal(dataNeraca, 30, 'F');
            const dpk = getVal(dataNeraca, 44, 'F') + getVal(dataNeraca, 45, 'F');
            const laba = getVal(dataNeraca, 70, 'F');

            const colN = 'M';
            const kpmm = getVal(dataKualitas, 28, colN);
            const npl = getVal(dataKualitas, 30, colN);
            const roa = getVal(dataKualitas, 32, colN);
            const bopo = getVal(dataKualitas, 33, colN);
            const nim = getVal(dataKualitas, 34, colN);
            const ldr = getVal(dataKualitas, 35, colN);
            const cr = getVal(dataKualitas, 36, colN);

            if(!db[kat]) db[kat] = [];
            db[kat].push({
                nama, per, sandi, prov, kota,
                modal, aset, kyd, dpk, laba,
                kpmm, npl, roa, bopo, nim, ldr, cr
            });

            renderPreview();
            modalInstance.hide();

        } catch (e) {
            console.error(e);
            alert("Gagal membaca file. Pastikan format Excel benar.");
        }
    }

    // --- 2. RENDER PREVIEW (HTML VISUAL) ---
    function renderPreview() {
        const tbody = document.getElementById('previewBody');
        tbody.innerHTML = '';
        if(Object.keys(db).length === 0) {
            tbody.innerHTML = '<tr><td colspan="17" class="text-center p-4">Belum ada data.</td></tr>';
            return;
        }

        for (const [kategori, items] of Object.entries(db)) {
            tbody.innerHTML += `<tr><td colspan="17" class="cat-row">${kategori}</td></tr>`;
            let sum = {modal:0, aset:0, kyd:0, dpk:0, laba:0};

            items.forEach(d => {
                sum.modal+=d.modal; sum.aset+=d.aset; sum.kyd+=d.kyd; sum.dpk+=d.dpk; sum.laba+=d.laba;
                tbody.innerHTML += `
                    <tr>
                        <td>${d.per}</td><td class="text-center">${d.sandi}</td><td>${d.nama}</td><td>${d.prov}</td><td>${d.kota}</td>
                        <td class="num">${fmtRp(d.modal)}</td><td class="num">${fmtRp(d.aset)}</td><td class="num">${fmtRp(d.kyd)}</td><td class="num">${fmtRp(d.dpk)}</td>
                        <td class="num ${d.laba<0?'text-neg':''}">${fmtRp(d.laba)}</td>
                        <td class="num">${fmtPct(d.kpmm)}</td><td class="num">${fmtPct(d.npl)}</td><td class="num ${d.roa<0?'text-neg':''}">${fmtPct(d.roa)}</td>
                        <td class="num">${fmtPct(d.bopo)}</td><td class="num">${fmtPct(d.nim)}</td><td class="num">${fmtPct(d.ldr)}</td><td class="num">${fmtPct(d.cr)}</td>
                    </tr>
                `;
            });

            if(items.length > 1) {
                tbody.innerHTML += `
                    <tr class="total-row"><td colspan="5" class="text-center">TOTAL</td>
                        <td class="num">${fmtRp(sum.modal)}</td><td class="num">${fmtRp(sum.aset)}</td><td class="num">${fmtRp(sum.kyd)}</td><td class="num">${fmtRp(sum.dpk)}</td>
                        <td class="num ${sum.laba<0?'text-neg':''}">${fmtRp(sum.laba)}</td>
                        <td colspan="7"></td>
                    </tr>
                `;
            }
        }
    }

    // --- 3. EXPORT KE EXCEL REAL (MENGGUNAKAN EXCELJS) ---
    async function exportToExcel() {
        if(Object.keys(db).length === 0) { alert("Tidak ada data untuk di-export."); return; }

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Laporan Konsolidasi');

        // Setup Kolom & Lebar
        worksheet.columns = [
            { width: 12 }, { width: 10 }, { width: 35 }, { width: 15 }, { width: 15 }, // Identitas
            { width: 18 }, { width: 18 }, { width: 18 }, { width: 18 }, { width: 18 }, // Nominal
            { width: 10 }, { width: 10 }, { width: 10 }, { width: 10 }, { width: 10 }, { width: 10 }, { width: 10 } // Rasio
        ];

        // --- STYLE GLOBAL ---
        const headerFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF107C41' } }; // Hijau OJK
        const fontHeader = { name: 'Calibri', size: 11, bold: true, color: { argb: 'FFFFFFFF' } }; // Putih
        const fontData = { name: 'Calibri', size: 11 };
        const borderStyle = { top: {style:'thin', color:{argb:'FFCCCCCC'}}, left: {style:'thin', color:{argb:'FFCCCCCC'}}, bottom: {style:'thin', color:{argb:'FFCCCCCC'}}, right: {style:'thin', color:{argb:'FFCCCCCC'}} };

        // --- BUAT JUDUL ---
        worksheet.mergeCells('A1:Q1');
        const titleCell = worksheet.getCell('A1');
        titleCell.value = "PERBANDINGAN KINERJA KEUANGAN SEBELUM DAN SESUDAH PENGGABUNGAN";
        titleCell.font = { name: 'Calibri', size: 14, bold: true, color: { argb: 'FF107C41' } };
        titleCell.alignment = { horizontal: 'center' };

        // --- BUAT HEADER TABEL ---
        // Baris 3 & 4
        const headers1 = ['PERIODE', 'SANDI', 'ANGGOTA', 'PROVINSI', 'DATI II', 'MODAL DISETOR', 'TOTAL ASET', 'KYD', 'DPK', 'L/R TAHUN BERJALAN', 'RASIO KEUANGAN (%)'];
        
        // Mapping Merge
        worksheet.mergeCells('A3:A4'); worksheet.getCell('A3').value = 'PERIODE';
        worksheet.mergeCells('B3:B4'); worksheet.getCell('B3').value = 'SANDI';
        worksheet.mergeCells('C3:C4'); worksheet.getCell('C3').value = 'ANGGOTA';
        worksheet.mergeCells('D3:D4'); worksheet.getCell('D3').value = 'PROVINSI';
        worksheet.mergeCells('E3:E4'); worksheet.getCell('E3').value = 'DATI II';
        worksheet.mergeCells('F3:F4'); worksheet.getCell('F3').value = 'MODAL DISETOR';
        worksheet.mergeCells('G3:G4'); worksheet.getCell('G3').value = 'TOTAL ASET';
        worksheet.mergeCells('H3:H4'); worksheet.getCell('H3').value = 'KYD';
        worksheet.mergeCells('I3:I4'); worksheet.getCell('I3').value = 'DPK';
        worksheet.mergeCells('J3:J4'); worksheet.getCell('J3').value = 'L/R TAHUN BERJALAN';
        
        // Rasio Header
        worksheet.mergeCells('K3:Q3'); 
        worksheet.getCell('K3').value = 'RASIO KEUANGAN (%)';
        
        // Sub Header Rasio (Baris 4)
        const rasioKeys = ['KPMM', 'NPL', 'ROA', 'BOPO', 'NIM', 'LDR', 'CR'];
        rasioKeys.forEach((r, i) => {
            const cell = worksheet.getCell(4, 11 + i); // Mulai kolom K (11)
            cell.value = r;
        });

        // Styling Header (A3 sampai Q4)
        for (let r = 3; r <= 4; r++) {
            for (let c = 1; c <= 17; c++) {
                const cell = worksheet.getCell(r, c);
                cell.fill = headerFill;
                cell.font = fontHeader;
                cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                cell.border = { top: {style:'thin', color:{argb:'FFFFFFFF'}}, left: {style:'thin', color:{argb:'FFFFFFFF'}}, bottom: {style:'thin', color:{argb:'FFFFFFFF'}}, right: {style:'thin', color:{argb:'FFFFFFFF'}} }; // Border putih
            }
        }

        let currentRow = 5;

        // --- ISI DATA ---
        for (const [kategori, items] of Object.entries(db)) {
            // Row Kategori
            worksheet.mergeCells(`A${currentRow}:Q${currentRow}`);
            const catCell = worksheet.getCell(`A${currentRow}`);
            catCell.value = kategori.toUpperCase();
            catCell.fill = headerFill; // Hijau sama
            catCell.font = fontHeader;
            catCell.alignment = { horizontal: 'left' };
            currentRow++;

            let sum = {modal:0, aset:0, kyd:0, dpk:0, laba:0};

            items.forEach(d => {
                sum.modal+=d.modal; sum.aset+=d.aset; sum.kyd+=d.kyd; sum.dpk+=d.dpk; sum.laba+=d.laba;

                const row = worksheet.getRow(currentRow);
                row.values = [
                    d.per, d.sandi, d.nama, d.prov, d.kota,
                    d.modal, d.aset, d.kyd, d.dpk, d.laba,
                    d.kpmm/100, d.npl/100, d.roa/100, d.bopo/100, d.nim/100, d.ldr/100, d.cr/100
                ];

                // Styling Row Data
                row.eachCell((cell, colNumber) => {
                    cell.font = fontData;
                    cell.border = borderStyle;
                    
                    // Format Angka Nominal (Kolom 6-10)
                    if (colNumber >= 6 && colNumber <= 10) {
                        cell.numFmt = '#,##0';
                        if (cell.value < 0) cell.font = { color: { argb: 'FFFF0000' } }; // Merah jika minus
                    }
                    // Format Persen (Kolom 11-17)
                    if (colNumber >= 11) {
                        cell.numFmt = '0.00%';
                        if (cell.value < 0) cell.font = { color: { argb: 'FFFF0000' } };
                    }
                });
                currentRow++;
            });

            // Row Total
            if (items.length > 1) {
                worksheet.mergeCells(`A${currentRow}:E${currentRow}`);
                const totLabel = worksheet.getCell(`A${currentRow}`);
                totLabel.value = "TOTAL";
                totLabel.alignment = { horizontal: 'center' };

                const row = worksheet.getRow(currentRow);
                // Set value manual biar merge cell aman
                worksheet.getCell(`F${currentRow}`).value = sum.modal;
                worksheet.getCell(`G${currentRow}`).value = sum.aset;
                worksheet.getCell(`H${currentRow}`).value = sum.kyd;
                worksheet.getCell(`I${currentRow}`).value = sum.dpk;
                worksheet.getCell(`J${currentRow}`).value = sum.laba;

                // Styling Total
                for(let c=1; c<=17; c++){
                    let cell = worksheet.getCell(currentRow, c);
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                    cell.font = { bold: true };
                    cell.border = { top: {style:'medium'}, bottom: {style:'medium'} };
                    if (c >= 6 && c <= 10) {
                        cell.numFmt = '#,##0';
                        if (cell.value < 0) cell.font = { color: { argb: 'FFFF0000' }, bold: true };
                    }
                }
                currentRow++;
            }
        }

        // --- DOWNLOAD ---
        const buffer = await workbook.xlsx.writeBuffer();
        let cleanName = lastBPRName.replace(/[^a-zA-Z0-9 ]/g, "_");
        saveAs(new Blob([buffer]), `Laporan_Keuangan_${cleanName}.xlsx`);
    }

    // --- HELPERS SCRAPING ---
    function readSheetJS(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1, defval:''}));
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function getVal(rows, r, cChar) {
        const cIdx = cChar.charCodeAt(0) - 65; 
        if(rows[r-1] && rows[r-1][cIdx]) return clean(rows[r-1][cIdx]);
        return 0;
    }

    function findVal(rows, keys, cIdx) {
        for(let r of rows) {
            if(keys.some(k => JSON.stringify(r).toUpperCase().includes(k))) {
                if(r[cIdx]) return clean(r[cIdx]);
            }
        }
        return 0;
    }

    function clean(v) {
        if(typeof v === 'number') return v;
        return parseFloat(String(v).replace(/\./g,'').replace(/,/g,'.').replace(/%/g,'')) || 0;
    }

    const fmtRp = (n) => n.toLocaleString('id-ID');
    const fmtPct = (n) => n.toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>